name: Create release
on:
  push:
    branches:
    - master
    - ci

jobs:
  release:
    name: Build
    runs-on: ubuntu-latest
    container: opensuse/tumbleweed
    steps:
      - name: Update packages
        run: zypper -n --gpg-auto-import-keys ref

      - name: Upgrade packages
        run: zypper -n --gpg-auto-import-keys dup -l -y

      - name: Install openSUSE dependencies
        run: zypper -n --gpg-auto-import-keys install glibc glibc-extra glibc-locale glibc-i18ndata glibc-32bit gcc gcc-c++ shadow which patch gperf wget curl git diffutils make cmake libtool pkg-config autoconf automake makeinfo meson ninja intltool tar gzip bzip2 xz p7zip p7zip-full lzip zip unzip gtk-doc gettext-tools scons bison flex ruby orc linux-glibc-devel glibc-devel libstdc++-devel file-devel libopenssl-devel libffi-devel gdk-pixbuf-devel python3-base python3-Mako python3-packaging python3-PyYAML libzstd-devel libzstd-devel-static pcre2-devel zlib-devel fmt-devel xxhash-devel doctest-devel Mesa-libGL-devel Mesa-libEGL-devel Mesa-libGLESv2-devel gh

      - name: Link python 3
        run: ln -s /usr/bin/python3 /usr/bin/python

      - name: Checkout
        uses: actions/checkout@v5

      - name: Add safe git directory
        run: git config --global --add safe.directory ${GITHUB_WORKSPACE}

      - name: Build
        shell: bash
        run: make -j 4 MXE_BUILD_TYPE="Release" MXE_VERBOSE=1

      - name: Create archive
        shell: bash
        run: |
          tar -cJf gnutls-mingw-x86.tar.xz usr/i686-w64-mingw32.shared/{include,lib,bin}
          tar -cJf gnutls-mingw-x86_64.tar.xz usr/x86_64-w64-mingw32.shared/{include,lib,bin}

      - name: Set release tag
        id: set_release_tag
        shell: bash
        run: echo "release_tag=release-$GITHUB_RUN_ID" >> $GITHUB_OUTPUT

      - name: Create new release
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/release'
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: gh release create -d -n "gnutls mingw for msvc" -t "gnutls mingw for msvc $GITHUB_RUN_ID" "${{steps.set_release_tag.outputs.release_tag}}" "gnutls-mingw-x86_64.tar.xz" "gnutls-mingw-x86.tar.xz"
